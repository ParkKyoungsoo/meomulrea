{"remainingRequest":"C:\\SSAFY\\git\\s03p23b304\\fe_chat\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\SSAFY\\git\\s03p23b304\\fe_chat\\src\\components\\Chat\\ChatList.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\SSAFY\\git\\s03p23b304\\fe_chat\\src\\components\\Chat\\ChatList.vue","mtime":1600910340540},{"path":"C:\\SSAFY\\git\\s03p23b304\\fe_chat\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\SSAFY\\git\\s03p23b304\\fe_chat\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"C:\\SSAFY\\git\\s03p23b304\\fe_chat\\node_modules\\vuetify-loader\\lib\\loader.js","mtime":1574476662000},{"path":"C:\\SSAFY\\git\\s03p23b304\\fe_chat\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\SSAFY\\git\\s03p23b304\\fe_chat\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KDQppbXBvcnQgKiBhcyBmaXJlYmFzZSBmcm9tICdmaXJlYmFzZScNCg0KZXhwb3J0IGRlZmF1bHQgew0KICBkYXRhICgpIHsNCiAgICByZXR1cm4gew0KICAgICAgbG9hZGVkQ2hhdHM6IFtdLA0KICAgICAgbG9hZGluZzogZmFsc2UNCiAgICB9DQogIH0sDQogIG1vdW50ZWQgKCkgew0KICAgIHRoaXMubG9hZFJlY2VudENoYXRzKCkNCiAgfSwNCiAgY29tcHV0ZWQ6IHsNCiAgICB1c2VyICgpIHsNCiAgICAgIHJldHVybiB0aGlzLiRzdG9yZS5nZXR0ZXJzLnVzZXINCiAgICB9LA0KICAgIGNoYXRzICgpIHsNCiAgICAgIHJldHVybiB0aGlzLmxvYWRlZENoYXRzDQogICAgfQ0KICB9LA0KICBtZXRob2RzOiB7DQogICAgbG9hZFJlY2VudENoYXRzIChsYXN0S2V5KSB7DQogICAgICBsZXQgdGhhdCA9IHRoaXMNCiAgICAgIGZpcmViYXNlLmRhdGFiYXNlKCkucmVmKCdjaGF0cycpLm9yZGVyQnlLZXkoKS5saW1pdFRvTGFzdCgyMCkub25jZSgidmFsdWUiLCBmdW5jdGlvbihzbmFwc2hvdCkgew0KICAgICAgICBzbmFwc2hvdC5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkU25hcHNob3QpIHsNCiAgICAgICAgICBsZXQgY2hhdCA9IGNoaWxkU25hcHNob3QudmFsKCkNCiAgICAgICAgICBjaGF0LmtleSA9IGNoaWxkU25hcHNob3Qua2V5DQogICAgICAgICAgdGhhdC5nZXRVc2VyQ291bnRGb3JDaGF0KGNoYXQpDQogICAgICAgICAgdGhhdC5sb2FkZWRDaGF0cy51bnNoaWZ0KGNoYXQpDQogICAgICAgIH0pDQogICAgICB9KQ0KICAgIH0sDQogICAgbG9hZFJlY2VudENoYXRzQnlMYXN0S2V5IChsYXN0S2V5KSB7DQogICAgICBsZXQgdGhhdCA9IHRoaXMNCiAgICAgIHRoYXQubG9hZGluZyA9IHRydWUNCiAgICAgIGZpcmViYXNlLmRhdGFiYXNlKCkucmVmKCdjaGF0cycpLm9yZGVyQnlLZXkoKS5lbmRBdChsYXN0S2V5KS5saW1pdFRvTGFzdCgyMCkub25jZSgidmFsdWUiLCBmdW5jdGlvbihzbmFwc2hvdCkgew0KICAgICAgICBsZXQgdGVtcEFycmF5ID0gW10NCiAgICAgICAgc25hcHNob3QuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgew0KICAgICAgICAgIGlmKGl0ZW0ua2V5ICE9IGxhc3RLZXkpIHsNCiAgICAgICAgICAgIGxldCBuZXdDaGF0ID0gaXRlbS52YWwoKQ0KICAgICAgICAgICAgbmV3Q2hhdC5rZXkgPSBpdGVtLmtleQ0KICAgICAgICAgICAgdGVtcEFycmF5LnB1c2gobmV3Q2hhdCkNCiAgICAgICAgICB9DQogICAgICAgIH0pDQogICAgICAgIGlmICh0ZW1wQXJyYXlbMF0ua2V5ID09PSB0ZW1wQXJyYXlbMV0ua2V5KSByZXR1cm4NCiAgICAgICAgdGVtcEFycmF5LnJldmVyc2UoKQ0KICAgICAgICB0ZW1wQXJyYXkuZm9yRWFjaChmdW5jdGlvbiAoY2hpbGQpIHsNCiAgICAgICAgICB0aGF0LmdldFVzZXJDb3VudEZvckNoYXQoY2hpbGQpDQogICAgICAgICAgdGhhdC5sb2FkZWRDaGF0cy5wdXNoKGNoaWxkKQ0KICAgICAgICB9KQ0KICAgICAgICB0aGF0LmxvYWRpbmcgPSBmYWxzZQ0KICAgICAgfSkNCiAgICB9LA0KICAgIGVudGVyQ2hhdCAoY2hhdCkgew0KICAgICAgaWYoY2hhdC5pc0FscmVhZHlKb2luZWQgfHwgY2hhdC51c2VyQ291bnQgPT0gbnVsbCkgew0KICAgICAgICByZXR1cm4NCiAgICAgIH0NCg0KICAgICAgbGV0IGNoYXRJZCA9IGNoYXQua2V5DQogICAgICBsZXQgdGltZSA9IG5ldyBEYXRlKCkudmFsdWVPZigpDQoNCiAgICAgIGxldCB1cGRhdGVzID0ge30NCiAgICAgIHVwZGF0ZXNbJy9jaGF0X21lbWJlcnMvJyArIGNoYXRJZCArICcvdXNlcnMvJyArIHRoaXMudXNlci5pZF0gPSB7dGltZXN0YW1wOiB0aW1lfQ0KICAgICAgdXBkYXRlc1sndXNlcnMvJyArIHRoaXMudXNlci5pZCArICcvY2hhdHMvJyArIGNoYXRJZF0gPSB7dGltZXN0YW1wOiB0aW1lfQ0KDQogICAgICBsZXQgdGhhdCA9IHRoaXMNCiAgICAgIGZpcmViYXNlLmRhdGFiYXNlKCkucmVmKCkudXBkYXRlKHVwZGF0ZXMpLnRoZW4oKCkgPT4gew0KICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL2NoYXQvJyArIGNoYXRJZCkNCiAgICAgIH0pDQogICAgfSwNCiAgICBvblNjcm9sbCgpIHsNCiAgICAgIGlmKHdpbmRvdy50b3Auc2Nyb2xsWSArIHdpbmRvdy5pbm5lckhlaWdodCA+PSBkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodCAtIDEwMCAmJiAhdGhpcy5sb2FkaW5nKSB7DQogICAgICAgIHRoaXMubG9hZFJlY2VudENoYXRzQnlMYXN0S2V5KHRoaXMubG9hZGVkQ2hhdHNbdGhpcy5sb2FkZWRDaGF0cy5sZW5ndGggLSAxXS5rZXkpDQogICAgICB9DQogICAgfSwNCiAgICBnZXRVc2VyQ291bnRGb3JDaGF0KGNoYXQpIHsNCiAgICAgIGxldCB0aGF0ID0gdGhpcw0KICAgICAgZmlyZWJhc2UuZGF0YWJhc2UoKS5yZWYoJ2NoYXRfbWVtYmVycycpLmNoaWxkKGNoYXQua2V5KS5jaGlsZCgidXNlcnMiKS5vbmNlKCJ2YWx1ZSIsIGZ1bmN0aW9uKHNuYXBzaG90KSB7DQogICAgICAgIHRoYXQuJHNldChjaGF0LCAidXNlckNvdW50Iiwgc25hcHNob3QubnVtQ2hpbGRyZW4oKSkNCiAgICAgICAgc25hcHNob3QuZm9yRWFjaCgodXNlcikgPT4gew0KICAgICAgICAgIGlmKHVzZXIua2V5ID09IHRoYXQudXNlci5pZCkgew0KICAgICAgICAgICAgdGhhdC4kc2V0KGNoYXQsICJpc0FscmVhZHlKb2luZWQiLCB0cnVlKQ0KICAgICAgICAgIH0NCiAgICAgICAgfSkNCiAgICAgIH0pDQogICAgfQ0KICB9LA0KICBjcmVhdGVkICgpIHsNCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCkNCiAgfSwNCiAgZGVzdHJveWVkICgpIHsNCiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCkNCiAgfSwNCiAgd2F0Y2g6IHsNCiAgICBsb2FkZWRDaGF0czogew0KICAgICAgZGVlcDogdHJ1ZSwNCiAgICAgIGhhbmRsZXIoKSB7DQogICAgICB9DQogICAgfQ0KICB9DQp9DQo="},{"version":3,"sources":["ChatList.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAwBA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"ChatList.vue","sourceRoot":"src/components/Chat","sourcesContent":["<template>\r\n  <v-container v-on:scroll=\"onScroll\" ref=\"chatlistContainer\">\r\n    <v-row no-gutters>\r\n      <v-col v-for=\"chat in chats\" :key=\"chat.name\" cols=\"12\" sm=\"4\">\r\n        <v-card class=\"mx-auto\" max-width=\"344\" outlined>\r\n          <v-list-item three-line>\r\n            <v-list-item-content>\r\n              <div class=\"overline mb-4\">{{chat.key}}</div>\r\n              <v-list-item-title class=\"headline mb-1\">{{chat.name}}</v-list-item-title>\r\n              <v-list-item-subtitle v-if=\"chat.userCount != null\">{{chat.userCount}} members have joined this chat.</v-list-item-subtitle>\r\n              <v-list-item-subtitle v-else>Loading user count...</v-list-item-subtitle>\r\n            </v-list-item-content>\r\n          </v-list-item>\r\n          <v-card-actions>\r\n            <v-btn text @click=\"enterChat(chat)\" v-if=\"!chat.isAlreadyJoined && chat.userCount != null\">Join</v-btn>\r\n            <v-btn text disabled v-if=\"chat.isAlreadyJoined\">Joined</v-btn>\r\n          </v-card-actions>\r\n        </v-card>\r\n      </v-col>\r\n    </v-row>\r\n  </v-container>\r\n</template>\r\n\r\n<script>\r\nimport * as firebase from 'firebase'\r\n\r\nexport default {\r\n  data () {\r\n    return {\r\n      loadedChats: [],\r\n      loading: false\r\n    }\r\n  },\r\n  mounted () {\r\n    this.loadRecentChats()\r\n  },\r\n  computed: {\r\n    user () {\r\n      return this.$store.getters.user\r\n    },\r\n    chats () {\r\n      return this.loadedChats\r\n    }\r\n  },\r\n  methods: {\r\n    loadRecentChats (lastKey) {\r\n      let that = this\r\n      firebase.database().ref('chats').orderByKey().limitToLast(20).once(\"value\", function(snapshot) {\r\n        snapshot.forEach(function(childSnapshot) {\r\n          let chat = childSnapshot.val()\r\n          chat.key = childSnapshot.key\r\n          that.getUserCountForChat(chat)\r\n          that.loadedChats.unshift(chat)\r\n        })\r\n      })\r\n    },\r\n    loadRecentChatsByLastKey (lastKey) {\r\n      let that = this\r\n      that.loading = true\r\n      firebase.database().ref('chats').orderByKey().endAt(lastKey).limitToLast(20).once(\"value\", function(snapshot) {\r\n        let tempArray = []\r\n        snapshot.forEach(function (item) {\r\n          if(item.key != lastKey) {\r\n            let newChat = item.val()\r\n            newChat.key = item.key\r\n            tempArray.push(newChat)\r\n          }\r\n        })\r\n        if (tempArray[0].key === tempArray[1].key) return\r\n        tempArray.reverse()\r\n        tempArray.forEach(function (child) {\r\n          that.getUserCountForChat(child)\r\n          that.loadedChats.push(child)\r\n        })\r\n        that.loading = false\r\n      })\r\n    },\r\n    enterChat (chat) {\r\n      if(chat.isAlreadyJoined || chat.userCount == null) {\r\n        return\r\n      }\r\n\r\n      let chatId = chat.key\r\n      let time = new Date().valueOf()\r\n\r\n      let updates = {}\r\n      updates['/chat_members/' + chatId + '/users/' + this.user.id] = {timestamp: time}\r\n      updates['users/' + this.user.id + '/chats/' + chatId] = {timestamp: time}\r\n\r\n      let that = this\r\n      firebase.database().ref().update(updates).then(() => {\r\n        this.$router.push('/chat/' + chatId)\r\n      })\r\n    },\r\n    onScroll() {\r\n      if(window.top.scrollY + window.innerHeight >= document.body.scrollHeight - 100 && !this.loading) {\r\n        this.loadRecentChatsByLastKey(this.loadedChats[this.loadedChats.length - 1].key)\r\n      }\r\n    },\r\n    getUserCountForChat(chat) {\r\n      let that = this\r\n      firebase.database().ref('chat_members').child(chat.key).child(\"users\").once(\"value\", function(snapshot) {\r\n        that.$set(chat, \"userCount\", snapshot.numChildren())\r\n        snapshot.forEach((user) => {\r\n          if(user.key == that.user.id) {\r\n            that.$set(chat, \"isAlreadyJoined\", true)\r\n          }\r\n        })\r\n      })\r\n    }\r\n  },\r\n  created () {\r\n    window.addEventListener('scroll', this.onScroll)\r\n  },\r\n  destroyed () {\r\n    window.removeEventListener('scroll', this.onScroll)\r\n  },\r\n  watch: {\r\n    loadedChats: {\r\n      deep: true,\r\n      handler() {\r\n      }\r\n    }\r\n  }\r\n}\r\n</script>"]}]}